/**
 * @file Firebase Security Rules for Diamond Digger application.
 *
 * @Core Philosophy
 * This ruleset enforces a strict user-ownership model for user profiles.
 * Each user can only access their own profile data.
 *
 * @Data Structure
 * All user data is stored under `/users/{userId}`.
 *
 * @Key Security Decisions
 * - Users can only access their own profile.
 * - Listing users is disallowed to prevent data leakage.
 * - Data validation is relaxed during this prototyping phase, but ownership is strictly enforced.
 *
 * @Denormalization for Authorization
 * The User document ID is enforced to match the Firebase Auth UID to ensure a direct, easily verifiable ownership relationship.
 *
 * @Structural Segregation
 * There is only one collection: `/users/{userId}`. This data is strictly private, and access is limited to the owner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles.
     * @path /users/{userId}
     * @allow (create) - User 'abc' can create their profile if authenticated as 'abc'.
     * @allow (get, update, delete) - User 'abc' can access their profile if authenticated as 'abc'.
     * @deny (create) - User 'def' cannot create a profile for 'abc'.
     * @deny (get, update, delete) - User 'def' cannot access user 'abc's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the authenticated user is the owner of the resource
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       // Helper function to check if the authenticated user is the owner of the existing resource
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow a user to create their own profile if the userId matches their auth.uid.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;

      // Allow a user to get their own profile if the userId matches their auth.uid.
      allow get: if isSignedIn() && isOwner(userId);

      // Allow a user to list users if the userId matches their auth.uid.
      allow list: if false;

      // Allow a user to update their own profile if the userId matches their auth.uid and profile exists.
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;

      // Allow a user to delete their own profile if the userId matches their auth.uid and profile exists.
      allow delete: if isExistingOwner(userId);
    }
  }
}